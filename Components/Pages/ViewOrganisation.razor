@page "/organisation/{Id:guid}"
@using FollowTheMoney.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<FollowTheMoneyDbContext> DbFactory
@rendermode InteractiveServer

<h1 class="mb-4">Organisation Details</h1>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
}
else if (organisation != null)
{
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="card-title mb-4">@organisation.Name</h2>

            <!-- Basic Info -->
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card border-0 bg-light p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">ID:</span>
                            <span class="text-muted">@organisation.Id</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 bg-light p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Industry:</span>
                            <span class="text-muted">@organisation.Industry</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Info -->
            <div class="row g-3 mt-4">
                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Type:</span>
                        <span class="text-muted">@organisation.Type</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Address:</span>
                        <span class="text-muted">@organisation.Address</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">City:</span>
                        <span class="text-muted">@organisation.City</span>
                    </div>
                </div>
            </div>

            <!-- More Address Info -->
            <div class="row g-3 mt-4">
                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">State:</span>
                        <span class="text-muted">@organisation.State</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Postcode:</span>
                        <span class="text-muted">@organisation.Postcode</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Website:</span>
                        <a href="@organisation.Website" target="_blank" class="text-decoration-none text-primary">
                            @organisation.Website
                        </a>
                    </div>
                </div>
            </div>

        

            <!-- Donations -->
            <div class="card border-0 bg-light p-3 mt-4">
                <h3 class="mb-3">Donations</h3>

                @if (organisation.Donations?.Any() == true)
                {
                    <ul class="list-unstyled">
                        @foreach (var donation in organisation.Donations)
                        {
                            <li class="mb-2">
                                <span class="fw-semibold">@donation.Value</span>
                                -
                                <span class="text-muted">@donation.DonationDate.ToString("dd/MM/yyyy")</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted">No Donations found.</p>
                }
            </div>

            <!-- Record Info -->
            <div class="row g-3 mt-4">
                <div class="col-md-6">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Created Date:</span>
                        <span class="text-muted">@organisation.CreatedDate.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 bg-light p-3">
                        <span class="fw-semibold">Updated Date:</span>
                        <span class="text-muted">@organisation.UpdatedDate.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center py-5">
        <p class="text-muted">Organisation not found.</p>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private Organisation? organisation;
    private bool isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        await Task.Delay(1);

        try
        {
            using var context = await DbFactory.CreateDbContextAsync();

            organisation = await context.Organisations
                .Include(o => o.Donations)
                .FirstOrDefaultAsync(o => o.Id == Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading organisation: {ex.Message}");
        }

        isLoading = false;
    }
}
