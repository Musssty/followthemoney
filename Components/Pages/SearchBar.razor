@using FollowTheMoney.Models
@using FollowTheMoney.Services
@inject DummyDataService DummyData

<div class="search-container mb-3">
    <div class="row g-3">
        <div class="col-md-6">
            <input type="text" 
                   class="form-control" 
                   @bind="searchText" 
                   @bind:event="oninput"
                   @bind:after="PerformSearch"
                   placeholder="Search politicians..." />
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedParty" @bind:after="PerformSearch">
                <option value="">All Parties</option>
                <option value="ALP">Labor (ALP)</option>
                <option value="LIB">Liberal (LIB)</option>
                <option value="GRN">Greens (GRN)</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedState" @bind:after="PerformSearch">
                <option value="">All States</option>
                <option value="NSW">NSW</option>
                <option value="VIC">VIC</option>
                <option value="QLD">QLD</option>
                <option value="SA">SA</option>
                <option value="WA">WA</option>
                <option value="TAS">TAS</option>
                <option value="ACT">ACT</option>
                <option value="NT">NT</option>
            </select>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col">
            <button class="btn btn-secondary" @onclick="ClearFilters">Clear All Filters</button>
        </div>
    </div>
</div>

@code {
    private string searchText = "";
    private string selectedParty = "";
    private string selectedState = "";
    private List<Politician> allPoliticians = new();
    
    [Parameter]
    public EventCallback<List<Politician>> OnSearchCompleted { get; set; }

    protected override void OnInitialized()
    {
        allPoliticians = DummyData.GetPoliticians();
        PerformSearch();
    }

    private async Task PerformSearch()
    {
        var results = await SearchPoliticians(searchText, selectedParty, selectedState);
        await OnSearchCompleted.InvokeAsync(results);
    }
    
    private async Task ClearFilters()
    {
        searchText = "";
        selectedParty = "";
        selectedState = "";
        await PerformSearch();
    }
    
    private async Task<List<Politician>> SearchPoliticians(string query, string party, string state)
    {
        await Task.Delay(50);
        
        var results = allPoliticians.AsEnumerable();
        
        if (!string.IsNullOrWhiteSpace(query))
        {
            results = results.Where(p => 
                p.FirstName.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.LastName.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.FullName.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.Position.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.ElectoralDivision.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.State.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.Dob.ToString("dd MMMM yyyy").Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.Dob.Year.ToString().Contains(query) ||
                p.TermStartDate.ToString("dd MMMM yyyy").Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.TermStartDate.Year.ToString().Contains(query) ||
                (p.TermEndDate.HasValue && p.TermEndDate.Value.ToString("dd MMMM yyyy").Contains(query, StringComparison.OrdinalIgnoreCase)) ||
                (p.PoliticalParty != null && (
                    p.PoliticalParty.Name.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                    p.PoliticalParty.Abbreviation.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                    p.PoliticalParty.Founded.ToString("dd MMMM yyyy").Contains(query, StringComparison.OrdinalIgnoreCase) ||
                    p.PoliticalParty.Founded.Year.ToString().Contains(query)
                )) ||
                p.Id.ToString().Contains(query)
            );
        }
        
        if (!string.IsNullOrWhiteSpace(party))
        {
            results = results.Where(p => p.PoliticalParty?.Abbreviation == party);
        }
        
        if (!string.IsNullOrWhiteSpace(state))
        {
            results = results.Where(p => p.State == state);
        }
        
        return results.ToList();
    }
}