@using FollowTheMoney.Models

<div class="search-container mb-3">
    <div class="row g-3">
        <div class="col-md-6">
            <input type="text" 
                   class="form-control" 
                   @bind="searchText" 
                   @bind:event="oninput"
                   @onkeyup="HandleKeyUp" 
                   placeholder="Search politicians..." />
        </div>
        <div class="col-md-3">
    <select class="form-select" @bind="selectedParty" @bind:after="PerformSearch">
        <option value="">All Parties</option>
        <option value="ALP">Labor (ALP)</option>
        <option value="LIB">Liberal (LIB)</option>
        <option value="GRN">Greens (GRN)</option>
    </select>
</div>
<div class="col-md-3">
    <select class="form-select" @bind="selectedState" @bind:after="PerformSearch">
        <option value="">All States</option>
        <option value="NSW">NSW</option>
        <option value="VIC">VIC</option>
        <option value="QLD">QLD</option>
        <option value="SA">SA</option>
        <option value="WA">WA</option>
        <option value="TAS">TAS</option>
        <option value="ACT">ACT</option>
        <option value="NT">NT</option>
    </select>
</div>
    </div>
    <div class="row mt-2">
        <div class="col">
            <button class="btn btn-primary" @onclick="PerformSearch">Search</button>
            <button class="btn btn-secondary ms-2" @onclick="ClearFilters">Clear Filters</button>
        </div>
    </div>
</div>

@code {
    private string searchText = "";
    private string selectedParty = "";
    private string selectedState = "";
    private List<Politician> allPoliticians = new();
    
    [Parameter]
    public EventCallback<List<Politician>> OnSearchCompleted { get; set; }

    protected override void OnInitialized()
    {
        allPoliticians = GetDummyPoliticians();
        Console.WriteLine($"Loaded {allPoliticians.Count} politicians");
    }

    private async Task PerformSearch()
    {
        Console.WriteLine($"PerformSearch called with: '{searchText}', Party: '{selectedParty}', State: '{selectedState}'");
        var results = await SearchPoliticians(searchText, selectedParty, selectedState);
        Console.WriteLine($"Found {results.Count} results");
        
        await OnSearchCompleted.InvokeAsync(results);
        Console.WriteLine("Invoked callback");
    }
    
    private async Task ClearFilters()
    {
        searchText = "";
        selectedParty = "";
        selectedState = "";
        await PerformSearch();
    }
    
    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        Console.WriteLine($"Key pressed: {e.Key}");
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }
    
    private async Task<List<Politician>> SearchPoliticians(string query, string party, string state)
    {
        await Task.Delay(100);
        
        var results = allPoliticians.AsEnumerable();
        
        // Filter by search text
        if (!string.IsNullOrWhiteSpace(query))
        {
            results = results.Where(p => 
                p.FirstName.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.LastName.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.ElectoralDivision.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.State.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                p.Position.Contains(query, StringComparison.OrdinalIgnoreCase));
        }
        
        // Filter by party
        if (!string.IsNullOrWhiteSpace(party))
        {
            results = results.Where(p => p.PoliticalParty?.Abbreviation == party);
        }
        
        // Filter by state
        if (!string.IsNullOrWhiteSpace(state))
        {
            results = results.Where(p => p.State == state);
        }
        
        var finalResults = results.ToList();
        Console.WriteLine($"Filtered to {finalResults.Count} results");
        return finalResults;
    }
    
    private List<Politician> GetDummyPoliticians()
    {
        return new List<Politician>
        {
            new Politician
            {
                Id = 1,
                FirstName = "Anthony",
                LastName = "Albanese",
                ElectoralDivision = "Grayndler",
                State = "NSW",
                Dob = new DateTime(1963, 3, 2),
                TermStartDate = new DateTime(2022, 5, 23),
                TermEndDate = null,
                Position = "Prime Minister",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 1,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 1,
                    Name = "Australian Labor Party",
                    Abbreviation = "ALP",
                    Founded = new DateTime(1901, 1, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 2,
                FirstName = "Peter",
                LastName = "Dutton",
                ElectoralDivision = "Dickson",
                State = "QLD",
                Dob = new DateTime(1970, 11, 18),
                TermStartDate = new DateTime(2001, 11, 10),
                TermEndDate = null,
                Position = "Opposition Leader",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 2,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 2,
                    Name = "Liberal Party of Australia",
                    Abbreviation = "LIB",
                    Founded = new DateTime(1944, 8, 31),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 3,
                FirstName = "Penny",
                LastName = "Wong",
                ElectoralDivision = "South Australia",
                State = "SA",
                Dob = new DateTime(1968, 11, 5),
                TermStartDate = new DateTime(2002, 7, 1),
                TermEndDate = null,
                Position = "Minister for Foreign Affairs",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 1,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 1,
                    Name = "Australian Labor Party",
                    Abbreviation = "ALP",
                    Founded = new DateTime(1901, 1, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 4,
                FirstName = "Adam",
                LastName = "Bandt",
                ElectoralDivision = "Melbourne",
                State = "VIC",
                Dob = new DateTime(1972, 3, 11),
                TermStartDate = new DateTime(2010, 8, 21),
                TermEndDate = null,
                Position = "Greens Leader",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 3,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 3,
                    Name = "Australian Greens",
                    Abbreviation = "GRN",
                    Founded = new DateTime(1992, 8, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 5,
                FirstName = "Jim",
                LastName = "Chalmers",
                ElectoralDivision = "Rankin",
                State = "QLD",
                Dob = new DateTime(1978, 3, 2),
                TermStartDate = new DateTime(2013, 9, 7),
                TermEndDate = null,
                Position = "Treasurer",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 1,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 1,
                    Name = "Australian Labor Party",
                    Abbreviation = "ALP",
                    Founded = new DateTime(1901, 1, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 6,
                FirstName = "Tanya",
                LastName = "Plibersek",
                ElectoralDivision = "Sydney",
                State = "NSW",
                Dob = new DateTime(1969, 12, 2),
                TermStartDate = new DateTime(1998, 10, 3),
                TermEndDate = null,
                Position = "Minister for the Environment and Water",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 1,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 1,
                    Name = "Australian Labor Party",
                    Abbreviation = "ALP",
                    Founded = new DateTime(1901, 1, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 7,
                FirstName = "Sussan",
                LastName = "Ley",
                ElectoralDivision = "Farrer",
                State = "NSW",
                Dob = new DateTime(1961, 12, 14),
                TermStartDate = new DateTime(2001, 11, 10),
                TermEndDate = null,
                Position = "Deputy Opposition Leader",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 2,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 2,
                    Name = "Liberal Party of Australia",
                    Abbreviation = "LIB",
                    Founded = new DateTime(1944, 8, 31),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            },
            new Politician
            {
                Id = 8,
                FirstName = "Richard",
                LastName = "Marles",
                ElectoralDivision = "Corio",
                State = "VIC",
                Dob = new DateTime(1967, 7, 13),
                TermStartDate = new DateTime(2007, 11, 24),
                TermEndDate = null,
                Position = "Deputy Prime Minister",
                CreatedDate = DateTime.Now.ToString(),
                UpdatedDate = DateTime.Now.ToString(),
                PoliticalPartyId = 1,
                PoliticalParty = new PoliticalParty 
                { 
                    Id = 1,
                    Name = "Australian Labor Party",
                    Abbreviation = "ALP",
                    Founded = new DateTime(1901, 1, 1),
                    CreatedDate = DateTime.Now.ToString(),
                    UpdatedDate = DateTime.Now.ToString()
                }
            }
        };
    }
}